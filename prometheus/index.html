<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=robots content="noodp">
<title class=pjax-title>Prometheus监控系统 - Yuepu`s Blog</title><meta name=Description content="关于 LoveIt 主题"><meta property="og:title" content="Prometheus监控系统">
<meta property="og:description" content="Prometheus（普罗米修斯）监控系统一、Prometheus概述1、什么是Prometheus？Prometheus [prəˈmi:θ">
<meta property="og:type" content="article">
<meta property="og:url" content="https://hyoung.site/prometheus/"><meta property="og:image" content="https://hyoung.site/prometheus/monitor.jpeg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-01-05T19:28:41+08:00">
<meta property="article:modified_time" content="2022-01-05T19:28:41+08:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://hyoung.site/prometheus/monitor.jpeg">
<meta name=twitter:title content="Prometheus监控系统">
<meta name=twitter:description content="Prometheus（普罗米修斯）监控系统一、Prometheus概述1、什么是Prometheus？Prometheus [prəˈmi:θ">
<meta name=application-name content="Yuepu`s Blog">
<meta name=apple-mobile-web-app-title content="Yuepu`s Blog">
<meta name=theme-color content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://hyoung.site/prometheus/><link rel=prev href=https://hyoung.site/paxos-algo/><link rel=next href=https://hyoung.site/nginx-file-server/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload="this.onload=null,this.rel='stylesheet'" href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css>
<noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css></noscript><link rel=preload as=style onload="this.onload=null,this.rel='stylesheet'" href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css>
<noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Prometheus监控系统","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/hyoung.site\/prometheus\/"},"image":[{"@type":"ImageObject","url":"https:\/\/hyoung.site\/prometheus\/monitor.jpeg","width":640,"height":427}],"genre":"posts","wordcount":8031,"url":"https:\/\/hyoung.site\/prometheus\/","datePublished":"2022-01-05T19:28:41+08:00","dateModified":"2022-01-05T19:28:41+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"Yuepu","logo":"https:\/\/hyoung.site\/images\/avatar.jpg"},"author":{"@type":"Person","name":"Yuepu"},"description":""}</script></head>
<body header-desktop=fixed header-mobile=auto><script type=text/javascript>function setTheme(a){document.body.setAttribute('theme',a),document.documentElement.style.setProperty('color-scheme',a==='light'?'light':'dark')}function saveTheme(a){window.localStorage&&localStorage.setItem('theme',a)}function getMeta(b){const a=document.getElementsByTagName('meta');for(let c=0;c<a.length;c++)if(a[c].getAttribute('name')===b)return a[c];return''}if(window.localStorage&&localStorage.getItem('theme')){let a=localStorage.getItem('theme');a==='light'||a==='dark'||a==='black'?setTheme(a):window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?setTheme('dark'):setTheme('light')}else'auto'==='light'||'auto'==='dark'||'auto'==='black'?(setTheme('auto'),saveTheme('auto')):(saveTheme('auto'),window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches?setTheme('dark'):setTheme('light'));let metaColors={light:'#f8f8f8',dark:'#252627',black:'#000000'};getMeta('theme-color').content=metaColors[document.body.getAttribute('theme')]</script>
<div id=back-to-top></div>
<div id=mask></div><div class=wrapper><header class=desktop id=header-desktop>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Yuepu`s Blog"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span><span id=desktop-header-typeit class=typeit></span></a>
</div>
<div class=menu>
<div class=menu-inner><a class=menu-item href=/posts/> 所有文章 </a><a class=menu-item href=/tags/> 标签 </a><a class=menu-item href=/categories/> 分类 </a><a class=menu-item href=/friends/> 友链 </a><a class=menu-item href=/about/> 关于 </a><a class=menu-item href=https://blog.csdn.net/weixin_41284138 title=CSDN rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i> </a><a class=menu-item href=https://k8syaml.com/ title=k8syaml rel="noopener noreffer" target=_blank><i class="fab fa-docker"></i> </a><a class=menu-item href=https://link.zhaouncle.com/ title=Link rel="noopener noreffer" target=_blank><i class="fas fa-link fa-fw"></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=# onclick=return!1 class="search-button search-toggle" id=search-toggle-desktop title=搜索>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=# onclick=return!1 class="search-button search-clear" id=search-clear-desktop title=清空>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-desktop>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</span><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</div>
</header><header class=mobile id=header-mobile>
<div class=header-container>
<div class=header-wrapper>
<div class=header-title>
<a href=/ title="Yuepu`s Blog"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span><span id=mobile-header-typeit class=typeit></span></a>
</div>
<div class=menu-toggle id=menu-toggle-mobile>
<span></span><span></span><span></span>
</div>
</div>
<div class=menu id=menu-mobile><div class=search-wrapper>
<div class="search mobile" id=search-mobile>
<input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=# onclick=return!1 class="search-button search-toggle" id=search-toggle-mobile title=搜索>
<i class="fas fa-search fa-fw"></i>
</a>
<a href=# onclick=return!1 class="search-button search-clear" id=search-clear-mobile title=清空>
<i class="fas fa-times-circle fa-fw"></i>
</a>
<span class="search-button search-loading" id=search-loading-mobile>
<i class="fas fa-spinner fa-fw fa-spin"></i>
</span>
</div>
<a href=# onclick=return!1 class=search-cancel id=search-cancel-mobile>
取消
</a>
</div><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/friends/ title>友链</a><a class=menu-item href=/about/ title>关于</a><a class=menu-item href=https://blog.csdn.net/weixin_41284138 title=CSDN rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a class=menu-item href=https://k8syaml.com/ title=k8syaml rel="noopener noreffer" target=_blank><i class="fab fa-docker"></i></a><a class=menu-item href=https://link.zhaouncle.com/ title=Link rel="noopener noreffer" target=_blank><i class="fas fa-link fa-fw"></i></a><a href=# onclick=return!1 class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i>
</a></div>
</div>
</header>
<div class="search-dropdown desktop">
<div id=search-dropdown-desktop></div>
</div>
<div class="search-dropdown mobile">
<div id=search-dropdown-mobile></div>
</div>
<main class=main>
<div class=container><div class=toc id=toc-auto>
<h2 class=toc-title>目录</h2>
<div class=toc-content id=toc-content-auto><nav id=TableOfContents>
<ul>
<li><a href=#prometheus普罗米修斯监控系统>Prometheus（普罗米修斯）监控系统</a>
<ul>
<li><a href=#一prometheus概述>一、Prometheus概述</a>
<ul>
<li><a href=#1什么是prometheus>1、什么是Prometheus？</a></li>
<li><a href=#2时间序列数据>2、时间序列数据</a></li>
<li><a href=#3prometheus的主要特征>3、Prometheus的主要特征</a></li>
<li><a href=#4prometheus基本原理>4、Prometheus基本原理</a></li>
<li><a href=#5架构图>5、架构图</a></li>
<li><a href=#6组件说明>6、组件说明</a></li>
</ul>
</li>
<li><a href=#二prometheus-部署与配置>二、Prometheus 部署与配置</a>
<ul>
<li><a href=#1安装prometheus>1、安装prometheus</a></li>
<li><a href=#2prometheus界面>2、prometheus界面</a></li>
<li><a href=#3-监控远程主机>3、 监控远程主机</a></li>
<li><a href=#4监控远程mysql>4、监控远程MySQL</a></li>
<li><a href=#5prometheu配置文件>5、prometheu配置文件</a></li>
</ul>
</li>
<li><a href=#三grafana可视化图形展示工具>三、Grafana可视化图形展示工具</a></li>
<li><a href=#四promql基本使用>四、PromQL基本使用</a>
<ul>
<li><a href=#1promql基本使用>1、PromQL基本使用</a></li>
<li><a href=#2常用函数>2、常用函数</a>
<ul>
<li><a href=#1rate函数>1、rate函数</a></li>
<li><a href=#2irate函数>2、irate函数</a></li>
<li><a href=#3其他函数>3、其他函数</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#五高可用方案>五、高可用方案</a>
<ul>
<li><a href=#1server高可用>1、server高可用</a></li>
<li><a href=#2alert高可用>2、alert高可用</a></li>
</ul>
</li>
<li><a href=#六扩展>六、扩展</a>
<ul>
<li><a href=#1prometheus数据类型>1、prometheus数据类型</a></li>
<li><a href=#2label的使用>2、label的使用</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav></div>
</div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle","normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Prometheus监控系统</h1><div class=post-meta>
<div class=post-meta-line>
<span class=post-author><i class="author fas fa-user-circle fa-fw"></i><a href=https://hyoung.site/ title=Author target=_blank rel="noopener noreffer author" class=author>Yuepu</a>
</span></div>
<div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2022-01-05>2022-01-05</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2022-01-05>2022-01-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 8031 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 17 分钟&nbsp;</div>
</div><div class=featured-image><img class=lazyload data-src=/prometheus/monitor.jpeg data-srcset="/prometheus/monitor.jpeg, /prometheus/monitor.jpeg 1.5x, /prometheus/monitor.jpeg 2x" data-sizes=auto alt=/prometheus/monitor.jpeg title=/prometheus/monitor.jpeg height=427 width=640></div><div class="details toc" id=toc-static kept>
<div class="details-summary toc-title">
<span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span>
</div>
<div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents>
<ul>
<li><a href=#prometheus普罗米修斯监控系统>Prometheus（普罗米修斯）监控系统</a>
<ul>
<li><a href=#一prometheus概述>一、Prometheus概述</a>
<ul>
<li><a href=#1什么是prometheus>1、什么是Prometheus？</a></li>
<li><a href=#2时间序列数据>2、时间序列数据</a></li>
<li><a href=#3prometheus的主要特征>3、Prometheus的主要特征</a></li>
<li><a href=#4prometheus基本原理>4、Prometheus基本原理</a></li>
<li><a href=#5架构图>5、架构图</a></li>
<li><a href=#6组件说明>6、组件说明</a></li>
</ul>
</li>
<li><a href=#二prometheus-部署与配置>二、Prometheus 部署与配置</a>
<ul>
<li><a href=#1安装prometheus>1、安装prometheus</a></li>
<li><a href=#2prometheus界面>2、prometheus界面</a></li>
<li><a href=#3-监控远程主机>3、 监控远程主机</a></li>
<li><a href=#4监控远程mysql>4、监控远程MySQL</a></li>
<li><a href=#5prometheu配置文件>5、prometheu配置文件</a></li>
</ul>
</li>
<li><a href=#三grafana可视化图形展示工具>三、Grafana可视化图形展示工具</a></li>
<li><a href=#四promql基本使用>四、PromQL基本使用</a>
<ul>
<li><a href=#1promql基本使用>1、PromQL基本使用</a></li>
<li><a href=#2常用函数>2、常用函数</a>
<ul>
<li><a href=#1rate函数>1、rate函数</a></li>
<li><a href=#2irate函数>2、irate函数</a></li>
<li><a href=#3其他函数>3、其他函数</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#五高可用方案>五、高可用方案</a>
<ul>
<li><a href=#1server高可用>1、server高可用</a></li>
<li><a href=#2alert高可用>2、alert高可用</a></li>
</ul>
</li>
<li><a href=#六扩展>六、扩展</a>
<ul>
<li><a href=#1prometheus数据类型>1、prometheus数据类型</a></li>
<li><a href=#2label的使用>2、label的使用</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav></div>
</div><div class=content id=content><h2 id=prometheus普罗米修斯监控系统 class=headerLink>
<a href=#prometheus%e6%99%ae%e7%bd%97%e7%b1%b3%e4%bf%ae%e6%96%af%e7%9b%91%e6%8e%a7%e7%b3%bb%e7%bb%9f class=header-mark></a>Prometheus（普罗米修斯）监控系统</h2><h3 id=一prometheus概述 class=headerLink>
<a href=#%e4%b8%80prometheus%e6%a6%82%e8%bf%b0 class=header-mark></a>一、Prometheus概述</h3><h4 id=1什么是prometheus class=headerLink>
<a href=#1%e4%bb%80%e4%b9%88%e6%98%afprometheus class=header-mark></a>1、什么是Prometheus？</h4><p>Prometheus <em>[prəˈmi:θi:əs, -ˌθju:s]</em> 是由SoundCloud使用Go语言开发的开源监控报警系统和时间序列数据库(TSDB)。Prometheus于 2016 年加入 <a href=https://cncf.io/ target=_blank rel="noopener noreffer">云原生计算基金会（CNCF）</a>，作为继<a href=https://kubernetes.io/ target=_blank rel="noopener noreffer">Kubernetes</a>之后的第二个托管项目，因为kubernetes的流行带动了prometheus的发展。</p>
<h4 id=2时间序列数据 class=headerLink>
<a href=#2%e6%97%b6%e9%97%b4%e5%ba%8f%e5%88%97%e6%95%b0%e6%8d%ae class=header-mark></a>2、时间序列数据</h4><p>什么是时间序列数据？</p>
<p><strong>时间序列数据</strong>(TimeSeries Data):按照时间顺序记录系统、设备状态变化的数据被称为时序数据。</p>
<p>应用的场景很多, 如：</p>
<ul>
<li>无人驾驶车辆运行中要记录的经度，纬度，速度，方向，旁边物体的距离等等。每时每刻都要将数据记录下来做分析。</li>
<li>某一个地区的各车辆的行驶轨迹数据</li>
<li>传统证券行业实时交易数据</li>
<li>实时运维监控数据，CPU、内存等实时数据</li>
</ul>
<p>时间序列数据特点：</p>
<ul>
<li>性能好</li>
</ul>
<p>关系型数据库对于大规模数据的处理性能糟糕。NOSQL可以比较好的处理大规模数据，让依然比不上时间序列数据库。</p>
<ul>
<li>存储成本低</li>
</ul>
<p>高效的压缩算法，节省存储空间，有效降低IO Prometheus有着非常高效的时间序列数据存储方法，每个采样数据仅仅占用3.5byte左右空间，上百万条时间序列，30秒间隔，保留60天，大概花了200多G（来自官方数据)</p>
<h4 id=3prometheus的主要特征 class=headerLink>
<a href=#3prometheus%e7%9a%84%e4%b8%bb%e8%a6%81%e7%89%b9%e5%be%81 class=header-mark></a>3、Prometheus的主要特征</h4><ul>
<li>多维度数据模型</li>
<li>灵活的查询语言</li>
<li>不依赖分布式存储，单个服务器节点是自主的</li>
<li>以HTTP方式，通过pull模型拉去时间序列数据</li>
<li>也可以通过中间网关支持push模型</li>
<li>通过服务发现或者静态配置，来发现目标服务对象</li>
<li>支持多种多样的图表和界面展示</li>
</ul>
<h4 id=4prometheus基本原理 class=headerLink>
<a href=#4prometheus%e5%9f%ba%e6%9c%ac%e5%8e%9f%e7%90%86 class=header-mark></a>4、Prometheus基本原理</h4><p>Prometheus <em>[prəˈmi:θi:əs, -ˌθju:s]</em> 的基本原理是使用 Pull （抓取）的方式，通过HTTP协议周期性抓取被监控组件的Metrics 数据（监控指标数据），然后，再把这些数据保存在一个 TSDB （时间序列数据库，比如 OpenTSDB、InfluxDB 等）当中，任意组件只要提供对应的HTTP接口就可以接入监控。不需要任何SDK或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，比如VM、Docker、Kubernetes等。</p>
<h4 id=5架构图 class=headerLink>
<a href=#5%e6%9e%b6%e6%9e%84%e5%9b%be class=header-mark></a>5、架构图</h4><p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/HIVSlpnvZYfbcGD.png data-srcset="https://s2.loli.net/2022/01/05/HIVSlpnvZYfbcGD.png, https://s2.loli.net/2022/01/05/HIVSlpnvZYfbcGD.png 1.5x, https://s2.loli.net/2022/01/05/HIVSlpnvZYfbcGD.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/HIVSlpnvZYfbcGD.png title=architecture.png></p>
<h4 id=6组件说明 class=headerLink>
<a href=#6%e7%bb%84%e4%bb%b6%e8%af%b4%e6%98%8e class=header-mark></a>6、组件说明</h4><ul>
<li><strong>Prometheus Server</strong>：主要用于抓取数据和存储时序数据，在该组件上配置监控数据的采集和告警规则.</li>
<li><strong>Push Gateway:</strong> 主要用于短期的 jobs。由于这类 jobs 存在时间较短, 可能在 Prometheus 来 pull 之前就消失了。为此, 这类jobs 可以直接向 Prometheus server 端推送它们的 metrics. 这种方式主要用于服务层面的 metrics, 对于机器层面的 metrics, 需要使用 node exporter.</li>
<li><strong>Exporter:</strong> 是 Prometheus的一类数据采集组件的总称，用于暴露已有的第三方服务的 metrics 给Prometheus。 它负责从目标处搜集数据, 并将其转化为Prometheus支持的格式. 与传统的数据采集组件不同的是, 它并不向中央服务器发送数据, 而是等待中央服务器主动前来抓取.</li>
<li><strong>AlertManager:</strong> 用于接收promethues发出的告警做进一步处理，对告警进行聚合、下发、抑制等。常见的告警方式有：邮件，钉钉，webhook 等一些其他的工具。</li>
<li><strong>Grafana:</strong> 第三方数据图表展示工具</li>
<li><strong>Service Discovery:</strong> 动态发现待监控的Target，从而完成监控配置的重要组件，在容器化环境中尤为有用；该组件目前由Prometheus Server 内建支持。</li>
</ul>
<p>每个组件都是独立工作的，不依赖其他组件。不同模块组件之间通过配置文件关联到一起，实现整个监控的功能。每个独立的模块都可以扩展，做高可用方案。</p>
<h3 id=二prometheus-部署与配置 class=headerLink>
<a href=#%e4%ba%8cprometheus-%e9%83%a8%e7%bd%b2%e4%b8%8e%e9%85%8d%e7%bd%ae class=header-mark></a>二、Prometheus 部署与配置</h3><h4 id=1安装prometheus class=headerLink>
<a href=#1%e5%ae%89%e8%a3%85prometheus class=header-mark></a>1、安装prometheus</h4><p>从 <a href=https://prometheus.io/download/ target=_blank rel="noopener noreffer">https://prometheus.io/download/</a> 下载相应版本，安装到服务器上官网提供的是二进制版，解压就能用，不需要编译</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>$ tar xf prometheus-2.5.0.linuxamd64.tar.gz -C /usr/local/
$ mv /usr/local/prometheus-2.5.0.linuxamd64/ /usr/local/prometheus
<span class=c1># 直接使用默认配置文件启动</span>
$ /usr/local/prometheus/prometheus --config.file<span class=o>=</span><span class=s2>&#34;/usr/local/prometheus/prometheus.yml&#34;</span> --web.enable-lifecycle <span class=p>&amp;</span>
<span class=c1># 启动时加上--web.enable-lifecycle启用远程热加载配置文件</span>
<span class=c1># 调用指令是curl -X POST http://localhost:9090/-/reload</span>
<span class=c1># 确认端口(9090)</span>
$ lsof -i:9090
COMMAND     PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
prometheu <span class=m>85396</span> root    8u  IPv6 <span class=m>2258519</span>      0t0  TCP *:websm <span class=o>(</span>LISTEN<span class=o>)</span>
</code></pre></td></tr></table>
</div>
</div><h4 id=2prometheus界面 class=headerLink>
<a href=#2prometheus%e7%95%8c%e9%9d%a2 class=header-mark></a>2、prometheus界面</h4><p>通过浏览器访问http://服务器IP:9090就可以访问到prometheus的主界面，点击Status &ndash;>点Targets &ndash;>可以看到只监控了prometheus server本机</p>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/5P6S32ilBuEf8WA.png data-srcset="https://s2.loli.net/2022/01/05/5P6S32ilBuEf8WA.png, https://s2.loli.net/2022/01/05/5P6S32ilBuEf8WA.png 1.5x, https://s2.loli.net/2022/01/05/5P6S32ilBuEf8WA.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/5P6S32ilBuEf8WA.png title=image-20211015162513132.png></p>
<p>访问http://10.101.1.51:9090/metrics可以查看到prometheus提供的自身 相关的metrics（指标）数据</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
# TYPE go_gc_duration_seconds summary
go_gc_duration_seconds{quantile=&#34;0&#34;} 3.6816e-05
go_gc_duration_seconds{quantile=&#34;0.25&#34;} 5.924e-05
go_gc_duration_seconds{quantile=&#34;0.5&#34;} 9.4932e-05
go_gc_duration_seconds{quantile=&#34;0.75&#34;} 0.000144405
go_gc_duration_seconds{quantile=&#34;1&#34;} 0.001375254
go_gc_duration_seconds_sum 0.036465283
go_gc_duration_seconds_count 270
# HELP go_goroutines Number of goroutines that currently exist.
# TYPE go_goroutines gauge
go_goroutines 31 
...
...
</code></pre></td></tr></table>
</div>
</div><p>在主界面可以通过关键字查询监控项</p>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/SqU1DWgwfhXbB3E.png data-srcset="https://s2.loli.net/2022/01/05/SqU1DWgwfhXbB3E.png, https://s2.loli.net/2022/01/05/SqU1DWgwfhXbB3E.png 1.5x, https://s2.loli.net/2022/01/05/SqU1DWgwfhXbB3E.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/SqU1DWgwfhXbB3E.png title=image-20211015162705646.png></p>
<h4 id=3-监控远程主机 class=headerLink>
<a href=#3-%e7%9b%91%e6%8e%a7%e8%bf%9c%e7%a8%8b%e4%b8%bb%e6%9c%ba class=header-mark></a>3、 监控远程主机</h4><ul>
<li>在远程linux主机(被监控端agent1)上安装node_exporter组件，下载地址: <a href=https://prometheus.io/download/ target=_blank rel="noopener noreffer">https://prometheus.io/download/</a></li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>$ tar xf node_exporter-0.16.0.linuxamd64.tar.gz -C /usr/local/
$ mv /usr/local/node_exporter-0.16.0.linuxamd64/ /usr/local/node_exporter
<span class=c1># 里面就一个启动命令node_exporter,可以直接使用此命令启动</span>
$ ls /usr/local/node_exporter/
LICENSE node_exporter NOTICE
$ nohup /usr/local/node_exporter/node_exporter <span class=p>&amp;</span>
<span class=c1># 确认端口(9100)</span>
$ lsof -i:9100
COMMAND     PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
node_expo <span class=m>83747</span> root    3u  IPv6 <span class=m>2272614</span>      0t0  TCP *:jetdirect <span class=o>(</span>LISTEN<span class=o>)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>通过浏览器访问http://被监控端ip:9100/metrics 就可以查看到node-exporter在被监控端收集到的信息</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback># HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
# TYPE go_gc_duration_seconds summary
go_gc_duration_seconds{quantile=&#34;0&#34;} 7.0401e-05
go_gc_duration_seconds{quantile=&#34;0.25&#34;} 7.0401e-05
go_gc_duration_seconds{quantile=&#34;0.5&#34;} 0.001011446
go_gc_duration_seconds{quantile=&#34;0.75&#34;} 0.001011446
go_gc_duration_seconds{quantile=&#34;1&#34;} 0.001011446
go_gc_duration_seconds_sum 0.001081847
go_gc_duration_seconds_count 2
# HELP go_goroutines Number of goroutines that currently exist.
# TYPE go_goroutines gauge
go_goroutines 8
# HELP go_info Information about the Go environment.
# TYPE go_info gauge
go_info{version=&#34;go1.16.7&#34;} 1
# HELP go_memstats_alloc_bytes Number of bytes allocated and still in use.
# TYPE go_memstats_alloc_bytes gauge
</code></pre></td></tr></table>
</div>
</div><ul>
<li>回到prometheus服务器的配置文件里添加被监控机器的配置段</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=c1># 在yml文件的最后添加被监控器的配置段</span>
$ vim /usr/local/prometheus.yml

  - job_name: <span class=s2>&#34;node-exporter&#34;</span>			<span class=c1># 添加新的监控项</span>
    static_configs:
      - targets: <span class=o>[</span><span class=s2>&#34;10.101.1.53:9100&#34;</span><span class=o>]</span>

<span class=c1># 修改完成后重新加载配置文件</span>
$ curl -X POST http://localhost:9090/-/reload
<span class=nv>level</span><span class=o>=</span>info <span class=nv>ts</span><span class=o>=</span>2021-10-15T08:41:40.889Z <span class=nv>caller</span><span class=o>=</span>main.go:1016 <span class=nv>msg</span><span class=o>=</span><span class=s2>&#34;Completed loading of configuration file&#34;</span> <span class=nv>filename</span><span class=o>=</span>/usr/local/prometheus/prometheus.yml
</code></pre></td></tr></table>
</div>
</div><ul>
<li>回到web界面查看targets，可以看到多了一台监控目标</li>
</ul>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/g2MRHy37hzsKVPm.png data-srcset="https://s2.loli.net/2022/01/05/g2MRHy37hzsKVPm.png, https://s2.loli.net/2022/01/05/g2MRHy37hzsKVPm.png 1.5x, https://s2.loli.net/2022/01/05/g2MRHy37hzsKVPm.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/g2MRHy37hzsKVPm.png title=image-20211015164342437.png></p>
<h4 id=4监控远程mysql class=headerLink>
<a href=#4%e7%9b%91%e6%8e%a7%e8%bf%9c%e7%a8%8bmysql class=header-mark></a>4、监控远程MySQL</h4><ul>
<li>在被管理机agent1上安装mysqld_exporter组件，下载地址: <a href=https://prometheus.io/download/ target=_blank rel="noopener noreffer">https://prometheus.io/download/</a>。操作和监控远程主机类似</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=c1># 安装mysqld_exporter组件</span>
<span class=o>[</span>root@agent1 ~<span class=o>]</span><span class=c1># tar xf mysqld_exporter-0.11.0.linuxamd64.</span>
tar.gz -C /usr/local/
<span class=o>[</span>root@agent1 ~<span class=o>]</span><span class=c1># mv /usr/local/mysqld_exporter-0.11.0.linux-amd64/ /usr/local/mysqld_exporter</span>
<span class=o>[</span>root@agent1 ~<span class=o>]</span><span class=c1># ls /usr/local/mysqld_exporter/</span>
LICENSE mysqld_exporter NOTICE
<span class=c1># 安装mariadb数据库,并授权</span>
<span class=o>[</span>root@agent1 ~<span class=o>]</span><span class=c1># yum install mariadb\* -y</span>
<span class=o>[</span>root@agent1 ~<span class=o>]</span><span class=c1># systemctl restart mariadb</span>
<span class=o>[</span>root@agent1 ~<span class=o>]</span><span class=c1># systemctl enable mariadb</span>
<span class=o>[</span>root@agent1 ~<span class=o>]</span><span class=c1># mysql</span>
MariaDB <span class=o>[(</span>none<span class=o>)]</span>&gt; grant <span class=k>select</span>,replication client,process ON *.* to <span class=s1>&#39;mysql_monitor&#39;</span>@<span class=s1>&#39;localhost&#39;</span> identified by <span class=s1>&#39;123&#39;</span><span class=p>;</span>
<span class=o>(</span>注意:授权ip为localhost，因为不是prometheus服务器来直接找mariadb获取数据，而是prometheus服务器找mysql_exporter,mysql_exporter再找mariadb。所以这个localhost是指的mysql_exporter的IP<span class=o>)</span>
MariaDB <span class=o>[(</span>none<span class=o>)]</span>&gt; flush privileges<span class=p>;</span>
<span class=c1># 查询权限授予的表</span>
MariaDB <span class=o>[(</span>none<span class=o>)]</span>&gt; <span class=k>select</span> * from mysql.user <span class=se>\G</span><span class=p>;</span>
MariaDB <span class=o>[(</span>none<span class=o>)]</span>&gt; quit
<span class=c1># 创建一个mariadb配置文件，写上连接的用户名与密码(和上面的授权的用户名和密码要对应)</span>
<span class=o>[</span>root@agent1 ~<span class=o>]</span><span class=c1># vim /usr/local/mysqld_exporter/.my.cnf</span>
<span class=o>[</span>client<span class=o>]</span>
<span class=nv>host</span><span class=o>=</span>127.0.0.1
<span class=nv>port</span><span class=o>=</span><span class=m>3306</span>
<span class=nv>user</span><span class=o>=</span>mysql_monitor
<span class=nv>password</span><span class=o>=</span><span class=m>123</span>
<span class=c1># 启动mysqld_exporter</span>
<span class=o>[</span>root@agent1 ~<span class=o>]</span><span class=c1># nohup /usr/local/mysqld_exporter/mysqld_exporter --config.my-cnf=&#34;/usr/local/mysqld_exporter/.my.cnf&#34; &amp;</span>
<span class=c1># 确认端口(9104)</span>
<span class=o>[</span>root@agent1 ~<span class=o>]</span><span class=c1># lsof -i:9104</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>回到prometheus服务器的配置文件里添加被监控的mysql的配置端</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>$ vim /usr/local/prometheus/prometheus.yml
 
- job_name: <span class=s2>&#34;mysql-exporter&#34;</span>           <span class=c1># 添加新的监控项</span>
    file_sd_configs:
      - files:
        - ./data/mysql_monitor_discovery.json
<span class=c1># 查看下json中填入的mysql信息</span>
$ cat ./data/mysql_monitor_discovery.json
<span class=o>[</span>
    <span class=o>{</span>
        <span class=s2>&#34;targets&#34;</span>:<span class=o>[</span>
            <span class=s2>&#34;10.101.1.53:9104&#34;</span>	
        <span class=o>]</span>
    <span class=o>}</span>
<span class=o>]</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>回到web界面查看targets，可以看到多了一台监控目标</li>
</ul>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/v4yP8c2pKbFe91Y.png data-srcset="https://s2.loli.net/2022/01/05/v4yP8c2pKbFe91Y.png, https://s2.loli.net/2022/01/05/v4yP8c2pKbFe91Y.png 1.5x, https://s2.loli.net/2022/01/05/v4yP8c2pKbFe91Y.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/v4yP8c2pKbFe91Y.png title=image-20211018174957845.png></p>
<p>可以查询mysql连接数等信息</p>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/YoUFLQfJEH9bBTh.png data-srcset="https://s2.loli.net/2022/01/05/YoUFLQfJEH9bBTh.png, https://s2.loli.net/2022/01/05/YoUFLQfJEH9bBTh.png 1.5x, https://s2.loli.net/2022/01/05/YoUFLQfJEH9bBTh.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/YoUFLQfJEH9bBTh.png title=image-20211018174821050.png></p>
<h4 id=5prometheu配置文件 class=headerLink>
<a href=#5prometheu%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 class=header-mark></a>5、prometheu配置文件</h4><ul>
<li>prometheus存储：</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>--storage.tsdb.path，prometheus写入tsdb数据库的位置，默认为data/。
--storage.tsdb.retention.time，数据保存天数，默认为15d。
</code></pre></td></tr></table>
</div>
</div><p>如果您的本地存储因任何原因而损坏，最好的办法是关闭Prometheus并删除整个存储目录。 Prometheus的本地存储不支持非POSIX兼容的文件系统，可能会发生损坏，无法恢复。 NFS只是潜在的POSIX，大多数实现都不是。您可以尝试删除单个块目录以解决问题，这意味着每个块目录丢失大约两个小时的数据时间窗口。同样，普罗米修斯的本地存储并不意味着持久的长期存储。</p>
<p>如果同时指定了时间和大小保留策略，则在该时刻将使用先触发的策略。</p>
<ul>
<li>prometheus主配置文件</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>$ vim prometheus.yml
<span class=c1># 默认的全局配置</span>
global:
  scrape_interval: 15s			<span class=c1># 抓取metrics指标数据间隔, 15秒向目标抓取一次数据</span>
  evaluation_interval: 15s		<span class=c1># 评估告警规则时间间隔, 每隔5分钟获取一次告警规则，触发告警检测的时间</span>

<span class=c1>#抓取相当于是写操作，把指标数据写入tsdb中。评估间隔相当于是读，读取tsdb中的指标给alert，alert根据指标数据去匹配告警规则是否要触发告警</span>

<span class=c1># Alertmanager的配置</span>
alerting:						<span class=c1># AlertManager监控报警配置</span>
  alertmanagers:
    - static_configs:
        - targets:
          <span class=c1># - alertmanager:9093	# alertmanager的服务地址，如127.0.0.1:9093</span>
          
<span class=c1># 一旦加载了报警规则文件，将按照evaluation_interval即15s一次进行计算，rule文件可以有多个</span>
rule_files:						<span class=c1># 告警规则文件配置</span>
  <span class=c1># - &#34;first_rules.yml&#34;</span>
  <span class=c1># - &#34;second_rules.yml&#34;</span>

<span class=c1># scrape_configs为采集配置，包含至少一个job</span>
scrape_configs:					<span class=c1># prometheus与抓取模块交互的接口配置</span>

  - job_name: <span class=s2>&#34;prometheus&#34;</span>		<span class=c1># Prometheus的自身监控</span>
    static_configs:
      - targets: <span class=o>[</span><span class=s2>&#34;localhost:9090&#34;</span><span class=o>]</span>

<span class=c1># 这个job是监控主机的，这个例子中用到了file_sd_configs的功能，就是通过配置文件的方法自动发现配置，之后有新添加的主机，直接维护下面files指定的文件就可以了，在那里面新增主机配置，prometheus会自动的发现并应用，这样做的好处是防止配置文件冗长，里面的文件格式为json格式：[{&#34;targets&#34;: [&#34;127.0.0.1:9100&#34;], &#34;labels&#34;: {&#34;instance&#34;: &#34;test&#34;}},{&#34;targets&#34;: [&#34;xx.xx.xx.xx:9100&#34;], &#34;labels&#34;: {&#34;instance&#34;: &#34;test1&#34;}}]推荐用这样的方法，我们在instance里面可以加上主机的属性来区分不同主机,比如说可以加上机房的区分</span>

<span class=c1># 静态配置的方式</span>
  - job_name: <span class=s2>&#34;node-exporter&#34;</span>		<span class=c1># 添加新的监控项</span>
    static_configs:
      - targets: <span class=o>[</span><span class=s2>&#34;10.101.1.53:9100&#34;</span><span class=o>]</span>
<span class=c1># 服务发现的方式</span>
  - job_name: <span class=s2>&#34;mysql-exporter&#34;</span>           <span class=c1># 添加新的监控项</span>
    file_sd_configs:
      <span class=c1>#refresh_interval: 1m 		# 刷新发现文件的时间间隔</span>
      - files:
        - ./data/mysql_monitor_discovery.json
</code></pre></td></tr></table>
</div>
</div><h3 id=三grafana可视化图形展示工具 class=headerLink>
<a href=#%e4%b8%89grafana%e5%8f%af%e8%a7%86%e5%8c%96%e5%9b%be%e5%bd%a2%e5%b1%95%e7%a4%ba%e5%b7%a5%e5%85%b7 class=header-mark></a>三、Grafana可视化图形展示工具</h3><p>Grafana是一个开源的度量分析和可视化工具，可以通过将采集的数据分析，查询，然后进行可视化的展示,并能实现报警</p>
<ul>
<li>安装grafana</li>
</ul>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=c1># 我这里选择的rpm包，下载后直接rpm -ivh安装就OK</span>
$ wget https://dl.grafana.com/enterprise/release/grafana-enterprise-8.2.1-1.x86_64.rpm
<span class=o>[</span>root@grafana ~<span class=o>]</span><span class=c1># rpm -ivh /root/Desktop/grafana-5.3.4-</span>
1.x86_64.rpm
<span class=c1># 启动服务</span>
<span class=o>[</span>root@grafana ~<span class=o>]</span><span class=c1># systemctl start grafana-server</span>
<span class=o>[</span>root@grafana ~<span class=o>]</span><span class=c1># systemctl enable grafana-server</span>
<span class=c1># 确认端口(3000)</span>
<span class=o>[</span>root@grafana ~<span class=o>]</span><span class=c1># lsof -i:3000</span>
</code></pre></td></tr></table>
</div>
</div><p>访问：http://10.101.1.52:3000，在Configuration中添加DataSource为prometheus的地址</p>
<ul>
<li>配置dashboard</li>
</ul>
<p>grafana官方图表库有很多优秀的数据图表，可以按需求下载使用。参考网址:https://grafana.com/grafana/dashboards/。 到官网直接搜索数据源为prometheus的dashboard，下载对应的json文件（这些json文件可以看作是开发人员开发的一个监控模板），导入到grafana即可展示。</p>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/R4vdPrsStMHeban.png data-srcset="https://s2.loli.net/2022/01/05/R4vdPrsStMHeban.png, https://s2.loli.net/2022/01/05/R4vdPrsStMHeban.png 1.5x, https://s2.loli.net/2022/01/05/R4vdPrsStMHeban.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/R4vdPrsStMHeban.png title=image-20211019155228769.png></p>
<h3 id=四promql基本使用 class=headerLink>
<a href=#%e5%9b%9bpromql%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 class=header-mark></a>四、PromQL基本使用</h3><h4 id=1promql基本使用 class=headerLink>
<a href=#1promql%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 class=header-mark></a>1、PromQL基本使用</h4><p>PromQL(Prometheus Query Language)是prometheus自己开发的数据查询DSL语言，语言表现力非常丰富，内置函数很多，在日常数据可视化以及rule告警中都会使用到它。我们把每个查询对象的名字叫做metrics，类似于mysql中的表名。</p>
<ul>
<li>查询结果</li>
</ul>
<blockquote>
<ul>
<li>瞬时数据：包含一组时序，每个时序只有一个点，例如：prometheus_http_request_total</li>
<li>区间数据：包含一组时序，每个时序有多个点，例如：prometheus_http_request_total [5m]</li>
<li>纯量数据：纯量只有一个数字，没有时序，例如：count(prometheus_http_request_total)</li>
</ul>
</blockquote>
<p>可以指定label的name查询，还支持算术运算。例如：+，-，*，/，比较运算：==，!=，>,&lt;,&lt;=,>=，逻辑运算and,or，聚合运算：sum,min,max,avg,count，内置函数：rate、irate、abs</p>
<p>常用的查询举例</p>
<ul>
<li>
<p>五分钟的CPU平均使用率：100 - (avg(irate(node_cpu_seconds_total{mode= &ldquo;idle&rdquo;}[5m])) * 100)</p>
</li>
<li>
<p>可用内存百分比：(node_memory_MemAvailable_bytes / (node_memory_MemTotal_bytes)) * 100</p>
</li>
<li>
<p>磁盘一分钟读的速率：irate(node_disk_reads_completed_total{instance=~"$node"}[1m])</p>
</li>
</ul>
<p>可以结合grafana丰富的dashboard，编辑图表查看PromQL更好的学习PromQL语法。</p>
<h4 id=2常用函数 class=headerLink>
<a href=#2%e5%b8%b8%e7%94%a8%e5%87%bd%e6%95%b0 class=header-mark></a>2、常用函数</h4><h5 id=1rate函数 class=headerLink>
<a href=#1rate%e5%87%bd%e6%95%b0 class=header-mark></a>1、rate函数</h5><p><strong>rate会取指定时间范围内所有数据点，算出一组速率，然后取平均值作为结果。</strong></p>
<p>单个counter类型的指标是无意义的，因为其只增不减，且重置就清零了。</p>
<p>rate（）函数用于计算在指定时间范围内计数器每秒增加量的平均值。</p>
<p>进行 rate 计算的时候是选择指定时间范围下的第一和最后一个样本进行计算，下图是表示瞬时计算的计算方式：</p>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/06/HkJFw7MLlsXxVzn.png data-srcset="https://s2.loli.net/2022/01/06/HkJFw7MLlsXxVzn.png, https://s2.loli.net/2022/01/06/HkJFw7MLlsXxVzn.png 1.5x, https://s2.loli.net/2022/01/06/HkJFw7MLlsXxVzn.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/06/HkJFw7MLlsXxVzn.png title=image-20211119162149655.png></p>
<p>往往我们需要的是绘制一个图形，那么就需要进行区间查询，指定一个时间范围内进行多次计算，将结果串联起来形成一个图形：</p>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/06/FfzAhQuEYrasoxO.png data-srcset="https://s2.loli.net/2022/01/06/FfzAhQuEYrasoxO.png, https://s2.loli.net/2022/01/06/FfzAhQuEYrasoxO.png 1.5x, https://s2.loli.net/2022/01/06/FfzAhQuEYrasoxO.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/06/FfzAhQuEYrasoxO.png title=image-20211119162244028.png></p>
<h5 id=2irate函数 class=headerLink>
<a href=#2irate%e5%87%bd%e6%95%b0 class=header-mark></a>2、irate函数</h5><p><strong>irate取的是在指定时间范围内的最近两个数据点来算速率。</strong></p>
<p>irate 同样用于计算区间向量的计算率，但是其反应出的是<strong>瞬时增长率</strong>。irate 函数是通过区间向量中最后两个样本数据来计算区间向量的增长速率。这种方式可以避免在时间窗口范围内的<strong>长尾问题</strong>，并且体现出更好的灵敏度，通过 irate 函数绘制的图标能够更好的反应样本数据的瞬时变化状态。</p>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/06/RrPHSzZMeCYTfL3.png data-srcset="https://s2.loli.net/2022/01/06/RrPHSzZMeCYTfL3.png, https://s2.loli.net/2022/01/06/RrPHSzZMeCYTfL3.png 1.5x, https://s2.loli.net/2022/01/06/RrPHSzZMeCYTfL3.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/06/RrPHSzZMeCYTfL3.png title=image-20211119163240021.png></p>
<h5 id=3其他函数 class=headerLink>
<a href=#3%e5%85%b6%e4%bb%96%e5%87%bd%e6%95%b0 class=header-mark></a>3、其他函数</h5><p><code>increase()</code></p>
<p><code>rate()</code>、<code>irate()</code> 和 <code>increase()</code> 函数只能输出非负值的结果，对于跟踪一个可以上升或下降的值的指标（如温度、内存或磁盘空间），可以使用 <code>delta()</code> 和 <code>deriv()</code> 函数来代替。</p>
<p>还有另外一个 <code>predict_linear()</code> 函数可以预测一个 <code>Gauge</code> 类型的指标在未来指定一段时间内的值，例如我们可以根据过去 15 分钟的变化情况，来预测一个小时后的磁盘使用量是多少，可以用如下所示的表达式来查询：</p>
<p><code>predict_linear(demo_disk_usage_bytes{job="demo"}[15m], 3600)</code></p>
<p>这个函数可以用于报警，告诉我们磁盘是否会在几个小时候内用完。</p>
<h3 id=五高可用方案 class=headerLink>
<a href=#%e4%ba%94%e9%ab%98%e5%8f%af%e7%94%a8%e6%96%b9%e6%a1%88 class=header-mark></a>五、高可用方案</h3><h4 id=1server高可用 class=headerLink>
<a href=#1server%e9%ab%98%e5%8f%af%e7%94%a8 class=header-mark></a>1、server高可用</h4><ul>
<li>部署多个相同配置的server</li>
</ul>
<p>A和B（甚至可以再加），保持相同的配置，收集相同的数据：</p>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/GHJFpu9Mm5ZTW2b.png data-srcset="https://s2.loli.net/2022/01/05/GHJFpu9Mm5ZTW2b.png, https://s2.loli.net/2022/01/05/GHJFpu9Mm5ZTW2b.png 1.5x, https://s2.loli.net/2022/01/05/GHJFpu9Mm5ZTW2b.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/GHJFpu9Mm5ZTW2b.png title=image-20211103164859417.png></p>
<p>优点：服务能够提供基本的可靠性；配置非常简单，只要保证配置文件一致即可。</p>
<p>缺点：无法扩展；数据不一致；本质是单点，数据量大的时候，会有性能瓶颈。</p>
<p>适用场景：小规模集群；短期存储的需求。</p>
<ul>
<li>remote storage（远程存储）</li>
</ul>
<p>如果ServerA出现故障，启动ServerB：</p>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/vQsHAt8zJhulcb2.png data-srcset="https://s2.loli.net/2022/01/05/vQsHAt8zJhulcb2.png, https://s2.loli.net/2022/01/05/vQsHAt8zJhulcb2.png 1.5x, https://s2.loli.net/2022/01/05/vQsHAt8zJhulcb2.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/vQsHAt8zJhulcb2.png title=image-20211103165303001.png></p>
<p>优点：保证数据一致；数据可长期存储；server 可以灵活迁移。</p>
<p>缺点：server同样是单点，数据量大的时候存在性能瓶颈</p>
<p>适用场景：小规模集群；数据长期存储。</p>
<ul>
<li>联邦集群</li>
</ul>
<p>Prometheus原生支持联邦架构，<strong>能够实现从别的prometheus来抓取符合特定条件的数据</strong>：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=nt>scrape_configs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;federate&#39;</span><span class=w>
</span><span class=w>    </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>15s</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=nt>honor_labels</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>    </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;/federate&#39;</span><span class=w>
</span><span class=w>
</span><span class=w>    </span><span class=nt>params</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>&#39;match[]&#39;</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=s1>&#39;{job=~&#34;kubernetes.*&#34;}&#39;</span><span class=w>	   </span><span class=c># 抓取了目标prometheus中job为kubernetes开头的所有监控项</span><span class=w>
</span><span class=w>    </span><span class=nt>static_configs</span><span class=p>:</span><span class=w>
</span><span class=w>      </span>- <span class=nt>targets</span><span class=p>:</span><span class=w>
</span><span class=w>        </span>- <span class=s1>&#39;source-prometheus-1:9090&#39;</span><span class=w>
</span><span class=w>        </span>- <span class=s1>&#39;source-prometheus-2:9090&#39;</span><span class=w>
</span><span class=w>        </span>- <span class=s1>&#39;source-prometheus-3:9090&#39;</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/izAE6CtWgIVTPqs.png data-srcset="https://s2.loli.net/2022/01/05/izAE6CtWgIVTPqs.png, https://s2.loli.net/2022/01/05/izAE6CtWgIVTPqs.png 1.5x, https://s2.loli.net/2022/01/05/izAE6CtWgIVTPqs.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/izAE6CtWgIVTPqs.png title=image-20211103171406437.png></p>
<p>优点：资料能够被持久化保持在第三方存储系统中；能够依旧不同任务进行层级划分；server可以灵活迁移；serverA和serverB可以用前面提到的方法进行高可用扩展。</p>
<p>缺点：单一资料中心带来的单点（ServerC压力较大）；分层带来的配置复杂，维护成本较高；监控成本较大。</p>
<p>适用场景：能够满足较大规模的监控需求；有很好地扩展；单资料中心下的较为完善的架构。</p>
<ul>
<li>多资料中心高可用架构</li>
</ul>
<blockquote>
<ul>
<li>
<p>多套k8s集群系统监控/cpu、内存、磁盘、网络等数据量不大</p>
</li>
<li>
<p>业务监控（nginx/grpc等）/和线上访问成正比，数据量巨大</p>
</li>
<li>
<p>各自特点：</p>
</li>
<li>
<p>系统监控要保存较长时间（要做长久的资源分析）</p>
</li>
<li>
<p>业务监控主要做实时探测，一般需求不会超过一星期（主要做实时业务成功率报警，历史数据分析从日志进行操作</p>
</li>
<li>
<p>多资料中心而且有不同存储需求</p>
</li>
</ul>
</blockquote>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/dSpfcoYkQD7BZja.png data-srcset="https://s2.loli.net/2022/01/05/dSpfcoYkQD7BZja.png, https://s2.loli.net/2022/01/05/dSpfcoYkQD7BZja.png 1.5x, https://s2.loli.net/2022/01/05/dSpfcoYkQD7BZja.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/dSpfcoYkQD7BZja.png title=image-20211103173325140.png></p>
<h4 id=2alert高可用 class=headerLink>
<a href=#2alert%e9%ab%98%e5%8f%af%e7%94%a8 class=header-mark></a>2、alert高可用</h4><h3 id=六扩展 class=headerLink>
<a href=#%e5%85%ad%e6%89%a9%e5%b1%95 class=header-mark></a>六、扩展</h3><h4 id=1prometheus数据类型 class=headerLink>
<a href=#1prometheus%e6%95%b0%e6%8d%ae%e7%b1%bb%e5%9e%8b class=header-mark></a>1、prometheus数据类型</h4><ul>
<li>
<p>数据模型</p>
<ul>
<li>metrics name & label 指标名称和标签（key=value)的形式组成。如<code>prometheus_http_requests_total{code="200",handler="/api/v1/label/:name/values",instance="localhost:9090",job="prometheus"}</code></li>
<li>一般由字母和下划线构成，prometheus_http_requests_total(应用名称_监测对象 _ 数值类型 _单位)</li>
<li>label（标签）就是对一条时间序列不同维度的识别，每个k-v对都是一个label。</li>
</ul>
</li>
<li>
<p>counter（计数器类型）</p>
<ul>
<li>counter类型的指标的工作方式和计数器一样，只增不减（除非系统发生了重置）。Counter一般用于累计值，例如记录请求次数、任务完成数，错误发生数。</li>
<li>通常来讲，许多指标counter本身并没有什么意义，有意义的是counter随时间的变化率。</li>
</ul>
</li>
<li>
<p>Gauge（仪表盘类型）</p>
<ul>
<li>Gauge是可增可减的指标类，可以用于反应当前应用的状态，比如机器内存、磁盘可用空间大小等。node_memory_MemAvailable_bytes/node_file</li>
</ul>
</li>
<li>
<p>Histogram（直方图类型）</p>
<ul>
<li>
<p>Histogram由<code>&lt;basename>_bucket，&lt;basename>_sum,&lt;basename>_counter</code>组成。主要用于表示一段时间范围内对数据进行采样（通常是请求持续时间或响应大小），并能够对其指定区间以及总数进行统计，通常它采集的数据展示为直方图。</p>
</li>
<li>
<p>事件发生的总次数：basename_count。</p>
</li>
<li>
<p>所有事件产生值的大小的总和：basename_sum.</p>
</li>
<li>
<p>事件产生的值分布在bucket中的次数。</p>
</li>
</ul>
</li>
</ul>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/Qc3fGjVobDF86tv.png data-srcset="https://s2.loli.net/2022/01/05/Qc3fGjVobDF86tv.png, https://s2.loli.net/2022/01/05/Qc3fGjVobDF86tv.png 1.5x, https://s2.loli.net/2022/01/05/Qc3fGjVobDF86tv.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/Qc3fGjVobDF86tv.png title=image-20211019110957499.png></p>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/S4rT8LtNQ3cHDMo.png data-srcset="https://s2.loli.net/2022/01/05/S4rT8LtNQ3cHDMo.png, https://s2.loli.net/2022/01/05/S4rT8LtNQ3cHDMo.png 1.5x, https://s2.loli.net/2022/01/05/S4rT8LtNQ3cHDMo.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/S4rT8LtNQ3cHDMo.png title=image-20211019111019426.png></p>
<ul>
<li>Summary（摘要类型）</li>
</ul>
<p>Summary类型和Histogram类型相似，由<code>&lt;basename>{quantile= "&lt;>"},&lt;basename>_sum,&lt;basename>_count</code>，主要用于表示一段时间内数据采样结果（通常是请求持续时间或响应大小），它直接存储了分位数据，而不是根据统计区间计算出来的。</p>
<p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/XCLNhdwfPoZbzy1.png data-srcset="https://s2.loli.net/2022/01/05/XCLNhdwfPoZbzy1.png, https://s2.loli.net/2022/01/05/XCLNhdwfPoZbzy1.png 1.5x, https://s2.loli.net/2022/01/05/XCLNhdwfPoZbzy1.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/XCLNhdwfPoZbzy1.png title=image-20211019111657571.png></p>
<ul>
<li>
<p>二者区别</p>
<ul>
<li>Histogram指标直接反应了在不同区间内样本的个数，区间通过标签le进行定义，同时对于Histogram的指标，我们还可以通过histogram_quantile()函数计算出其值的分位数。</li>
<li>而Summary的分位数则是直接在客户端计算完成。</li>
<li>因此对于分位数的计算而言，Summary在通过PromQL进行查询时有更好的性能表现，而Histogram是在prometheus server上计算的，会消耗更多的资源，反之对于客户端而言Histogram消耗的资源更少。在选择这两种方式时用户应该按照自己的实际场景进行选择。</li>
</ul>
</li>
</ul>
<h4 id=2label的使用 class=headerLink>
<a href=#2label%e7%9a%84%e4%bd%bf%e7%94%a8 class=header-mark></a>2、label的使用</h4><p>label（标签）使用</p>
<p>label能够让我们知道监控项目的来源端口方法等，同时label也为prometheus提供了丰富的聚合和查询等功能。<strong>可以在targets中看到已有的label有哪些，在实际使用中需要对冗长的label进行格式处理，以更加清晰可读的方式展示出来。</strong></p>
<p><strong>label的操作：</strong></p>
<blockquote>
<p>keep 只保留符合匹配的标签；</p>
<p>Drop 丢弃符合匹配的标签；</p>
<p>还支持<strong>replace、labelmap</strong>、keep、drop等操作</p>
</blockquote>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=c># 在Prometheus采集数据之前，通过Target实例的Metadata信息，动态重新写入Label的值。</span><span class=w>
</span><span class=w></span><span class=c># 如将原始的__meta_kubernetes_namespace直接写成namespace，简洁明了</span><span class=w>
</span><span class=w>
</span><span class=w></span>- <span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes-nodes</span><span class=w>
</span><span class=w>  </span><span class=nt>scrape_interval</span><span class=p>:</span><span class=w> </span><span class=l>1m</span><span class=w>
</span><span class=w>  </span><span class=nt>scrape_timeout</span><span class=p>:</span><span class=w> </span><span class=l>10s</span><span class=w>
</span><span class=w>  </span><span class=nt>metrics_path</span><span class=p>:</span><span class=w> </span><span class=l>/metrics</span><span class=w>
</span><span class=w>  </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>https</span><span class=w>
</span><span class=w>  </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>api_server</span><span class=p>:</span><span class=w> </span><span class=kc>null</span><span class=w>
</span><span class=w>    </span><span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span><span class=w>    </span><span class=nt>namespaces</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>names</span><span class=p>:</span><span class=w> </span><span class=p>[]</span><span class=w>
</span><span class=w>  </span><span class=nt>bearer_token_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span class=w>
</span><span class=w>  </span><span class=nt>tls_config</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>ca_file</span><span class=p>:</span><span class=w> </span><span class=l>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span class=w>
</span><span class=w>    </span><span class=nt>insecure_skip_verify</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>
</span><span class=w>  </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span><span class=w>  </span>- <span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=l>;</span><span class=w>
</span><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_node_label_(.+)</span><span class=w>
</span><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>$1</span><span class=w>
</span><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span><span class=w>  </span>- <span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=l>;</span><span class=w>
</span><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.*)</span><span class=w>
</span><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.default.svc:443</span><span class=w>
</span><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>  </span>- <span class=nt>source_labels</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>__meta_kubernetes_node_name]</span><span class=w>
</span><span class=w>    </span><span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>replace</span><span class=w>
</span><span class=w>    </span><span class=nt>separator</span><span class=p>:</span><span class=w> </span><span class=l>;</span><span class=w>
</span><span class=w>    </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span><span class=w>    </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>/api/v1/nodes/${1}/proxy/metrics</span><span class=w>
</span><span class=w>    </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p><img class=lazyload data-src=https://s2.loli.net/2022/01/05/BTMhorUgS5VQXiL.png data-srcset="https://s2.loli.net/2022/01/05/BTMhorUgS5VQXiL.png, https://s2.loli.net/2022/01/05/BTMhorUgS5VQXiL.png 1.5x, https://s2.loli.net/2022/01/05/BTMhorUgS5VQXiL.png 2x" data-sizes=auto alt=https://s2.loli.net/2022/01/05/BTMhorUgS5VQXiL.png title=image-20211019171632643.png></p>
</div>
<div class=post-footer id=post-footer>
<div class=post-info>
<div class=post-info-line>
<div class=post-info-mod>
<span>更新于 2022-01-05</span>
</div>
<div class=post-info-license></div>
</div>
<div class=post-info-line>
<div class=post-info-md></div>
<div class=post-info-share>
<span><a href=# onclick=return!1 title="分享到 Twitter" data-sharer=twitter data-url=https://hyoung.site/prometheus/ data-title=Prometheus监控系统><i class="fab fa-twitter fa-fw"></i></a><a href=# onclick=return!1 title="分享到 Facebook" data-sharer=facebook data-url=https://hyoung.site/prometheus/><i class="fab fa-facebook-square fa-fw"></i></a><a href=# onclick=return!1 title="分享到 微博" data-sharer=weibo data-url=https://hyoung.site/prometheus/ data-title=Prometheus监控系统><i class="fab fa-weibo fa-fw"></i></a></span>
</div>
</div>
</div>
<div class=post-info-more>
<section class=post-tags></section>
<section>
<span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span>
</section>
</div>
<div class=post-nav><a href=/paxos-algo/ class=prev rel=prev title=Paxos算法学习><i class="fas fa-angle-left fa-fw"></i>Paxos算法学习</a>
<a href=/nginx-file-server/ class=next rel=next title="Nginx File Server">Nginx File Server<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id=comments><div id=utterances></div><noscript>
Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.
</noscript></div></article></div>
</main><footer class=footer>
<div class=footer-container><div class=footer-line>
由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.92.2">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreffer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a>
</div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2021 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=https://hyoung.site/ target=_blank rel="noopener noreferrer">Yuepu</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br>
<span class=icp><a href=https://beian.miit.gov.cn/ target=_blank>赣ICP备2021004104号-2</a><a href=http://www.beian.gov.cn/portal/registerSystemInfo target=_blank>|赣公网安备 36102602000137</a></span></div>
<div class=footer-line></div>
<div class=footer-line>
</div>
</div></footer></div>
<div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title=回到顶部>
<i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论>
<i class="fas fa-comment fa-fw"></i>
</a>
</div><div class=assets><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.0/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.11.0/dist/algoliasearch.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/topbar@1.0.1/topbar.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/@sliphua/pjax@2.4.0/dist/pjax.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script></div>
<div class=pjax-assets><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"HuangPingyang1/HuangPingyang1.github.io"}},data:{"desktop-header-typeit":"Yuepu`s Blog","mobile-header-typeit":"Yuepu`s Blog"},search:{algoliaAppID:"SSC09FNCJM",algoliaIndex:"yuepu-blog",algoliaSearchKey:"693f3aaed8c244ef45db45c4c06657b6",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},sharerjs:!0,typeit:{cursorChar:"|",cursorSpeed:1e3,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:-1,speed:100}}</script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.2/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js></script></div>
</body>
</html>